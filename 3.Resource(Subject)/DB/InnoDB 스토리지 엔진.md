# PK 에 의한 클러스터링

레코드를 PK  순으로 정렬해서 디스크에 저장

PK INDEX 자동 생성(조회 속도 빠름)

PK 를 통해서만 레코드에 접근 가능

클러스터링 떄문에 쓰기 성능 저하
- PK 순서가 바뀌면 그에 따른 물리적인 레코드 순서도 하나씩 변경 필요



# Transaction 지원

MVCC(Multi Version Concurrency Control)
- 트랜잭션 격리 수준에 따라 조회 결과가 달라지는 기술

Transaction 시작 후 UPDATE를 하면 변경 내역은 InnoDB 버퍼풀이라는 임시 공간에 저장된다. 그리고 변경 이전 값이 언두 로그에 기록된다. COMMIT을 해야만 실제 DB에 갱신이 된다.

ex) 트랜잭션에서 UPDATE를 한 후 조회 시 결과

```sql
UPDATE USER SET hobby = '코딩' WHERE id = 1;
```

- READ_UNCOMMITTED 격리 수준
	- InnoDB 버퍼풀의 변경 내역 출력
	- 변경된 값 이 결과로 전달
- READ_COMMITTED, REATABLE_READ, SSERIALAZABLE 격리 수준
	- 언두 로그의 결과 출력
	- 변경 이전 값 결과로 전달

언두 로그(Undo Log)
- 트랜잭션 보장(Rollback시 언두 로그에 백업된 데이터 복원)
- 트랜잭션 격리 수준 보장(트랜잭션 격리 수준에 맞게, 백업된 데이터 반환)
- 변경되기 이전 데이터를 백업

리두 로그(Redo Log)
- 트랜잭션의 영속성 보장(서버 비정상 종료시 리두 로그에 백업된 데이터 복원)
- 변경된 데이터를 백업(Commit 완료된 데이터)


# 레코드 단위 잠금

레코드 단위로 잠금을 걸기 떄문에 동시 처리 성능이 좋다

사실 레코드 자체를 잠그는 것이 아니라 레코드를 검색 하는데 사용되는 INDEX를 잠근다. INDEX를 잠궜지만 레코드도 따라서 잠기게 되는 것이다.

# INDEX 설정에 따라 잠기는 범위가 달라진다.

ex) '성'씨에 INDEX 설정한 컬럼

INDEX 검색한 레코드가 300개이면 300개의 INDEX 레코드가 잠기고 이 INDEX가 가리키는 테이블의 레코드도 같이 잠기게 된다.

![[Pasted image 20231210191035.png]]

만약 INDEX로 검색을 하지 못하였다면 기본으로 설정된 PK 인덱스를 사용하여 테이블 풀스캔을 한다.  이떄는 전체 레코드가 잠기게 되어 성능 문제 발생

![[Pasted image 20231210191016.png]]

만약 성씨와 이름에 대한 인덱스를 설정 하였다면 인덱스 결과가 1개라서 1나의 레코드에 대해서만 잠금이 발생 하기에 성능이 빨라질 것이다

![[Pasted image 20231210191549.png]]


# InnoDB 버퍼풀

버퍼풀의 용도
- 데이터 캐싱
- 쓰기 지연 버퍼 : 버퍼풀은 쓰기 작업을 지연 시켜 추후 일괄적으로 처리하도록 한다.

데이터 캐싱
- 인덱스 정보와 데이터 파일을 메모리에 캐싱
- 페이지 단위로 테이블 데이터를 관리
- 페이지 교체 알고리즘으로 LRU 사용

쓰기 지연 버퍼
- 변경된 데이터를 버퍼풀에 모았다가, 한 번에 디스크에 기록
	- INSERT, UPDATE, DELETE 명령으로 변경된 페이지를 더티 페이지라 부름
	- 더티 페이지를 모았다가 주기적으로 이벤트를 발생하여 한번에 모아서 처리
		- 랜덤 I/O를 줄이기 위해
- JPA 영속 컨텍스트의 쓰기 지연 SQL 저장소랑 비슷

# 어댑티브 해시 인덱스

페이지에 빠르게 접근하기 위한 해시 자료구조 기반 인덱스

(INDEX 키, 페이지 주소 값) 쌍으로 구성됨

자주 요청되는 페이지에 대해 InnoDB가 자동으로 생성하는 인덱스

# InnoDB vs MyISAM

|                           | InnoDB                       | MyISAM           |
| ------------------------- | ---------------------------- | ---------------- |
| 클러스터링 테이블(인덱스) | O                            | X                |
| 외래키 설정 지원          | O                            | X                |
| 트랜잭션 지원             | O                            | X                |
| Lockinig Level(잠금 방식) | 레코드 단위 잠금             | 테이블 단위 잠금 |
| 데이터 캐싱               | 버퍼풀 사용                  | 키 캐시 사용     |
|                           | (인덱스, 테이블 데이터 캐싱) | (인덱스 캐싱)    |


